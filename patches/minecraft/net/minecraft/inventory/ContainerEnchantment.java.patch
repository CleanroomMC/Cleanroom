--- before/net/minecraft/inventory/ContainerEnchantment.java
+++ after/net/minecraft/inventory/ContainerEnchantment.java
@@ -72,10 +72,13 @@
         });
         this.addSlotToContainer(new Slot(this.tableInventory, 1, 35, 47)
         {
+            java.util.List<ItemStack> ores = net.minecraftforge.oredict.OreDictionary.getOres("gemLapis");
             @Override
             public boolean isItemValid(ItemStack stack)
             {
-                return stack.getItem() == Items.DYE && EnumDyeColor.byDyeDamage(stack.getMetadata()) == EnumDyeColor.BLUE;
+                for (ItemStack ore : ores)
+                    if (net.minecraftforge.oredict.OreDictionary.itemMatches(ore, stack, false)) return true;
+                return false;
             }
         });
 
@@ -164,6 +167,7 @@
                 if (!this.world.isRemote)
                 {
                     int l = 0;
+                    float power = 0;
 
                     for (int j = -1; j <= 1; j++)
                     {
@@ -173,37 +177,14 @@
                                     && this.world.isAirBlock(this.position.add(k, 0, j))
                                     && this.world.isAirBlock(this.position.add(k, 1, j)))
                             {
-                                if (this.world.getBlockState(this.position.add(k * 2, 0, j * 2)).getBlock() == Blocks.BOOKSHELF)
-                                {
-                                    l++;
-                                }
-
-                                if (this.world.getBlockState(this.position.add(k * 2, 1, j * 2)).getBlock() == Blocks.BOOKSHELF)
-                                {
-                                    l++;
-                                }
-
+                                power += net.minecraftforge.common.ForgeHooks.getEnchantPower(world, position.add(k * 2, 0, j * 2));
+                                power += net.minecraftforge.common.ForgeHooks.getEnchantPower(world, position.add(k * 2, 1, j * 2));
                                 if (k != 0 && j != 0)
                                 {
-                                    if (this.world.getBlockState(this.position.add(k * 2, 0, j)).getBlock() == Blocks.BOOKSHELF)
-                                    {
-                                        l++;
-                                    }
-
-                                    if (this.world.getBlockState(this.position.add(k * 2, 1, j)).getBlock() == Blocks.BOOKSHELF)
-                                    {
-                                        l++;
-                                    }
-
-                                    if (this.world.getBlockState(this.position.add(k, 0, j * 2)).getBlock() == Blocks.BOOKSHELF)
-                                    {
-                                        l++;
-                                    }
-
-                                    if (this.world.getBlockState(this.position.add(k, 1, j * 2)).getBlock() == Blocks.BOOKSHELF)
-                                    {
-                                        l++;
-                                    }
+                                    power += net.minecraftforge.common.ForgeHooks.getEnchantPower(world, position.add(k * 2, 0, j));
+                                    power += net.minecraftforge.common.ForgeHooks.getEnchantPower(world, position.add(k * 2, 1, j));
+                                    power += net.minecraftforge.common.ForgeHooks.getEnchantPower(world, position.add(k, 0, j * 2));
+                                    power += net.minecraftforge.common.ForgeHooks.getEnchantPower(world, position.add(k, 1, j * 2));
                                 }
                             }
                         }
@@ -213,7 +194,7 @@
 
                     for (int i1 = 0; i1 < 3; i1++)
                     {
-                        this.enchantLevels[i1] = EnchantmentHelper.calcItemStackEnchantability(this.rand, i1, l, itemstack);
+                        this.enchantLevels[i1] = EnchantmentHelper.calcItemStackEnchantability(this.rand, i1, (int)power, itemstack);
                         this.enchantClue[i1] = -1;
                         this.worldClue[i1] = -1;
 
@@ -221,6 +202,7 @@
                         {
                             this.enchantLevels[i1] = 0;
                         }
+                        this.enchantLevels[i1] = net.minecraftforge.event.ForgeEventFactory.onEnchantmentLevelSet(world, position, i1, (int)power, itemstack, enchantLevels[i1]);
                     }
 
                     for (int j1 = 0; j1 < 3; j1++)
@@ -420,10 +402,9 @@
                     return ItemStack.EMPTY;
                 }
 
-                if (itemstack1.hasTagCompound() && itemstack1.getCount() == 1)
+                if (itemstack1.hasTagCompound())// Forge: Fix MC-17431
                 {
-                    this.inventorySlots.get(0).putStack(itemstack1.copy());
-                    itemstack1.setCount(0);
+                    this.inventorySlots.get(0).putStack(itemstack1.splitStack(1));
                 }
                 else if (!itemstack1.isEmpty())
                 {
