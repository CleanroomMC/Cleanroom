--- before/net/minecraft/client/renderer/EntityRenderer.java
+++ after/net/minecraft/client/renderer/EntityRenderer.java
@@ -5,8 +5,8 @@
 import com.google.gson.JsonSyntaxException;
 import java.awt.Graphics;
 import java.awt.image.BufferedImage;
+import java.awt.image.ImageObserver;
 import java.io.IOException;
-import java.nio.Buffer;
 import java.nio.FloatBuffer;
 import java.util.List;
 import java.util.Random;
@@ -52,6 +52,7 @@
 import net.minecraft.item.ItemStack;
 import net.minecraft.util.BlockRenderLayer;
 import net.minecraft.util.EntitySelectors;
+import net.minecraft.util.EnumFacing;
 import net.minecraft.util.EnumParticleTypes;
 import net.minecraft.util.MouseFilter;
 import net.minecraft.util.ReportedException;
@@ -127,7 +128,7 @@
     private float field_78539_ae;
     private int field_175079_V;
     private boolean field_175078_W;
-    private double field_78503_V = 1.0;
+    private double field_78503_V = 1.0D;
     private double field_78502_W;
     private double field_78509_X;
     private ItemStack field_190566_ab;
@@ -135,40 +136,15 @@
     private float field_190568_ad;
     private float field_190569_ae;
     private ShaderGroup field_147707_d;
-    private static final ResourceLocation[] field_147712_ad = new ResourceLocation[]
-        {
-            new ResourceLocation("shaders/post/notch.json"),
-            new ResourceLocation("shaders/post/fxaa.json"),
-            new ResourceLocation("shaders/post/art.json"),
-            new ResourceLocation("shaders/post/bumpy.json"),
-            new ResourceLocation("shaders/post/blobs2.json"),
-            new ResourceLocation("shaders/post/pencil.json"),
-            new ResourceLocation("shaders/post/color_convolve.json"),
-            new ResourceLocation("shaders/post/deconverge.json"),
-            new ResourceLocation("shaders/post/flip.json"),
-            new ResourceLocation("shaders/post/invert.json"),
-            new ResourceLocation("shaders/post/ntsc.json"),
-            new ResourceLocation("shaders/post/outline.json"),
-            new ResourceLocation("shaders/post/phosphor.json"),
-            new ResourceLocation("shaders/post/scan_pincushion.json"),
-            new ResourceLocation("shaders/post/sobel.json"),
-            new ResourceLocation("shaders/post/bits.json"),
-            new ResourceLocation("shaders/post/desaturate.json"),
-            new ResourceLocation("shaders/post/green.json"),
-            new ResourceLocation("shaders/post/blur.json"),
-            new ResourceLocation("shaders/post/wobble.json"),
-            new ResourceLocation("shaders/post/blobs.json"),
-            new ResourceLocation("shaders/post/antialias.json"),
-            new ResourceLocation("shaders/post/creeper.json"),
-            new ResourceLocation("shaders/post/spider.json")
-        };
+    private static final ResourceLocation[] field_147712_ad = new ResourceLocation[] {new ResourceLocation("shaders/post/notch.json"), new ResourceLocation("shaders/post/fxaa.json"), new ResourceLocation("shaders/post/art.json"), new ResourceLocation("shaders/post/bumpy.json"), new ResourceLocation("shaders/post/blobs2.json"), new ResourceLocation("shaders/post/pencil.json"), new ResourceLocation("shaders/post/color_convolve.json"), new ResourceLocation("shaders/post/deconverge.json"), new ResourceLocation("shaders/post/flip.json"), new ResourceLocation("shaders/post/invert.json"), new ResourceLocation("shaders/post/ntsc.json"), new ResourceLocation("shaders/post/outline.json"), new ResourceLocation("shaders/post/phosphor.json"), new ResourceLocation("shaders/post/scan_pincushion.json"), new ResourceLocation("shaders/post/sobel.json"), new ResourceLocation("shaders/post/bits.json"), new ResourceLocation("shaders/post/desaturate.json"), new ResourceLocation("shaders/post/green.json"), new ResourceLocation("shaders/post/blur.json"), new ResourceLocation("shaders/post/wobble.json"), new ResourceLocation("shaders/post/blobs.json"), new ResourceLocation("shaders/post/antialias.json"), new ResourceLocation("shaders/post/creeper.json"), new ResourceLocation("shaders/post/spider.json")};
     public static final int field_147708_e = field_147712_ad.length;
-    private int field_147713_ae = field_147708_e;
+    private int field_147713_ae;
     private boolean field_175083_ad;
     private int field_175084_ae;
 
     public EntityRenderer(Minecraft p_i45076_1_, IResourceManager p_i45076_2_)
     {
+        this.field_147713_ae = field_147708_e;
         this.field_78531_r = p_i45076_1_;
         this.field_147711_ac = p_i45076_2_;
         this.field_78516_c = p_i45076_1_.func_175597_ag();
@@ -235,6 +211,7 @@
             {
                 this.func_175069_a(new ResourceLocation("shaders/post/invert.json"));
             }
+            else net.minecraftforge.client.ForgeHooksClient.loadEntityShader(p_175066_1_, this);
         }
     }
 
@@ -260,7 +237,6 @@
         }
     }
 
-    @Override
     public void func_110549_a(IResourceManager p_110549_1_)
     {
         if (this.field_147707_d != null)
@@ -315,7 +291,7 @@
             this.field_78531_r.func_175607_a(this.field_78531_r.field_71439_g);
         }
 
-        float f3 = this.field_78531_r.field_71441_e.func_175724_o(new BlockPos(this.field_78531_r.func_175606_aa()));
+        float f3 = this.field_78531_r.field_71441_e.func_175724_o(new BlockPos(this.field_78531_r.func_175606_aa().func_174824_e(1F))); // Forge: fix MC-51150
         float f4 = (float)this.field_78531_r.field_71474_y.field_151451_c / 32.0F;
         float f2 = f3 * (1.0F - f4) + f4;
         this.field_78539_ae += (f2 - this.field_78539_ae) * 0.1F;
@@ -386,12 +362,12 @@
 
                 if (this.field_78531_r.field_71442_b.func_78749_i())
                 {
-                    d1 = 6.0;
+                    d1 = 6.0D;
                     d0 = d1;
                 }
                 else
                 {
-                    if (d0 > 3.0)
+                    if (d0 > 3.0D)
                     {
                         flag = true;
                     }
@@ -407,21 +383,13 @@
                 this.field_78528_u = null;
                 Vec3d vec3d3 = null;
                 float f = 1.0F;
-                List<Entity> list = this.field_78531_r
-                                    .field_71441_e
-                                    .func_175674_a(
-                                        entity,
-                                        entity.func_174813_aQ()
-                                        .func_72321_a(vec3d1.field_72450_a * d0, vec3d1.field_72448_b * d0, vec3d1.field_72449_c * d0)
-                                        .func_72314_b(1.0, 1.0, 1.0),
-                                        Predicates.and(EntitySelectors.field_180132_d, new Predicate<Entity>()
+                List<Entity> list = this.field_78531_r.field_71441_e.func_175674_a(entity, entity.func_174813_aQ().func_72321_a(vec3d1.field_72450_a * d0, vec3d1.field_72448_b * d0, vec3d1.field_72449_c * d0).func_72314_b(1.0D, 1.0D, 1.0D), Predicates.and(EntitySelectors.field_180132_d, new Predicate<Entity>()
                 {
                     public boolean apply(@Nullable Entity p_apply_1_)
                     {
                         return p_apply_1_ != null && p_apply_1_.func_70067_L();
                     }
-                })
-                                    );
+                }));
                 double d2 = d1;
 
                 for (int j = 0; j < list.size(); ++j)
@@ -432,22 +400,22 @@
 
                     if (axisalignedbb.func_72318_a(vec3d))
                     {
-                        if (d2 >= 0.0)
+                        if (d2 >= 0.0D)
                         {
                             this.field_78528_u = entity1;
                             vec3d3 = raytraceresult == null ? vec3d : raytraceresult.field_72307_f;
-                            d2 = 0.0;
+                            d2 = 0.0D;
                         }
                     }
                     else if (raytraceresult != null)
                     {
                         double d3 = vec3d.func_72438_d(raytraceresult.field_72307_f);
 
-                        if (d3 < d2 || d2 == 0.0)
+                        if (d3 < d2 || d2 == 0.0D)
                         {
-                            if (entity1.func_184208_bv() == entity.func_184208_bv())
+                            if (entity1.func_184208_bv() == entity.func_184208_bv() && !entity1.canRiderInteract())
                             {
-                                if (d2 == 0.0)
+                                if (d2 == 0.0D)
                                 {
                                     this.field_78528_u = entity1;
                                     vec3d3 = raytraceresult.field_72307_f;
@@ -463,10 +431,10 @@
                     }
                 }
 
-                if (this.field_78528_u != null && flag && vec3d.func_72438_d(vec3d3) > 3.0)
+                if (this.field_78528_u != null && flag && vec3d.func_72438_d(vec3d3) > 3.0D)
                 {
                     this.field_78528_u = null;
-                    this.field_78531_r.field_71476_x = new RayTraceResult(RayTraceResult.Type.MISS, vec3d3, null, new BlockPos(vec3d3));
+                    this.field_78531_r.field_71476_x = new RayTraceResult(RayTraceResult.Type.MISS, vec3d3, (EnumFacing)null, new BlockPos(vec3d3));
                 }
 
                 if (this.field_78528_u != null && (d2 < d1 || this.field_78531_r.field_71476_x == null))
@@ -522,7 +490,7 @@
             if (p_78481_2_)
             {
                 f = this.field_78531_r.field_71474_y.field_74334_X;
-                f *= this.field_78506_S + (this.field_78507_R - this.field_78506_S) * p_78481_1_;
+                f = f * (this.field_78506_S + (this.field_78507_R - this.field_78506_S) * p_78481_1_);
             }
 
             if (entity instanceof EntityLivingBase && ((EntityLivingBase)entity).func_110143_aJ() <= 0.0F)
@@ -538,7 +506,7 @@
                 f = f * 60.0F / 70.0F;
             }
 
-            return f;
+            return net.minecraftforge.client.ForgeHooksClient.getFOVModifier(this, entity, iblockstate, p_78481_1_, f);
         }
     }
 
@@ -560,8 +528,8 @@
                 return;
             }
 
-            f /= (float)entitylivingbase.field_70738_aO;
-            f = MathHelper.func_76126_a(f * f * f * f * (float) Math.PI);
+            f = f / (float)entitylivingbase.field_70738_aO;
+            f = MathHelper.func_76126_a(f * f * f * f * (float)Math.PI);
             float f2 = entitylivingbase.field_70739_aP;
             GlStateManager.func_179114_b(-f2, 0.0F, 1.0F, 0.0F);
             GlStateManager.func_179114_b(-f * 14.0F, 0.0F, 0.0F, 1.0F);
@@ -578,11 +546,9 @@
             float f1 = -(entityplayer.field_70140_Q + f * p_78475_1_);
             float f2 = entityplayer.field_71107_bF + (entityplayer.field_71109_bG - entityplayer.field_71107_bF) * p_78475_1_;
             float f3 = entityplayer.field_70727_aS + (entityplayer.field_70726_aT - entityplayer.field_70727_aS) * p_78475_1_;
-            GlStateManager.func_179109_b(
-                MathHelper.func_76126_a(f1 * (float) Math.PI) * f2 * 0.5F, -Math.abs(MathHelper.func_76134_b(f1 * (float) Math.PI) * f2), 0.0F
-            );
-            GlStateManager.func_179114_b(MathHelper.func_76126_a(f1 * (float) Math.PI) * f2 * 3.0F, 0.0F, 0.0F, 1.0F);
-            GlStateManager.func_179114_b(Math.abs(MathHelper.func_76134_b(f1 * (float) Math.PI - 0.2F) * f2) * 5.0F, 1.0F, 0.0F, 0.0F);
+            GlStateManager.func_179109_b(MathHelper.func_76126_a(f1 * (float)Math.PI) * f2 * 0.5F, -Math.abs(MathHelper.func_76134_b(f1 * (float)Math.PI) * f2), 0.0F);
+            GlStateManager.func_179114_b(MathHelper.func_76126_a(f1 * (float)Math.PI) * f2 * 3.0F, 0.0F, 0.0F, 1.0F);
+            GlStateManager.func_179114_b(Math.abs(MathHelper.func_76134_b(f1 * (float)Math.PI - 0.2F) * f2) * 5.0F, 1.0F, 0.0F, 0.0F);
             GlStateManager.func_179114_b(f3, 1.0F, 0.0F, 0.0F);
         }
     }
@@ -597,20 +563,14 @@
 
         if (entity instanceof EntityLivingBase && ((EntityLivingBase)entity).func_70608_bn())
         {
-            f = (float)((double)f + 1.0);
+            f = (float)((double)f + 1.0D);
             GlStateManager.func_179109_b(0.0F, 0.3F, 0.0F);
 
             if (!this.field_78531_r.field_71474_y.field_74325_U)
             {
                 BlockPos blockpos = new BlockPos(entity);
                 IBlockState iblockstate = this.field_78531_r.field_71441_e.func_180495_p(blockpos);
-                Block block = iblockstate.func_177230_c();
-
-                if (block == Blocks.field_150324_C)
-                {
-                    int j = iblockstate.func_177229_b(BlockBed.field_185512_D).func_176736_b();
-                    GlStateManager.func_179114_b((float)(j * 90), 0.0F, 1.0F, 0.0F);
-                }
+                net.minecraftforge.client.ForgeHooksClient.orientBedCamera(this.field_78531_r.field_71441_e, blockpos, iblockstate, entity);
 
                 GlStateManager.func_179114_b(entity.field_70126_B + (entity.field_70177_z - entity.field_70126_B) * p_78467_1_ + 180.0F, 0.0F, -1.0F, 0.0F);
                 GlStateManager.func_179114_b(entity.field_70127_C + (entity.field_70125_A - entity.field_70127_C) * p_78467_1_, -1.0F, 0.0F, 0.0F);
@@ -634,24 +594,19 @@
                     f2 += 180.0F;
                 }
 
-                double d4 = (double)(-MathHelper.func_76126_a(f1 * (float)(Math.PI / 180.0)) * MathHelper.func_76134_b(f2 * (float)(Math.PI / 180.0))) * d3;
-                double d5 = (double)(MathHelper.func_76134_b(f1 * (float)(Math.PI / 180.0)) * MathHelper.func_76134_b(f2 * (float)(Math.PI / 180.0))) * d3;
-                double d6 = (double)(-MathHelper.func_76126_a(f2 * (float)(Math.PI / 180.0))) * d3;
+                double d4 = (double)(-MathHelper.func_76126_a(f1 * 0.017453292F) * MathHelper.func_76134_b(f2 * 0.017453292F)) * d3;
+                double d5 = (double)(MathHelper.func_76134_b(f1 * 0.017453292F) * MathHelper.func_76134_b(f2 * 0.017453292F)) * d3;
+                double d6 = (double)(-MathHelper.func_76126_a(f2 * 0.017453292F)) * d3;
 
                 for (int i = 0; i < 8; ++i)
                 {
                     float f3 = (float)((i & 1) * 2 - 1);
                     float f4 = (float)((i >> 1 & 1) * 2 - 1);
                     float f5 = (float)((i >> 2 & 1) * 2 - 1);
-                    f3 *= 0.1F;
-                    f4 *= 0.1F;
-                    f5 *= 0.1F;
-                    RayTraceResult raytraceresult = this.field_78531_r
-                                                    .field_71441_e
-                                                    .func_72933_a(
-                                                        new Vec3d(d0 + (double)f3, d1 + (double)f4, d2 + (double)f5),
-                                                        new Vec3d(d0 - d4 + (double)f3 + (double)f5, d1 - d6 + (double)f4, d2 - d5 + (double)f5)
-                                                    );
+                    f3 = f3 * 0.1F;
+                    f4 = f4 * 0.1F;
+                    f5 = f5 * 0.1F;
+                    RayTraceResult raytraceresult = this.field_78531_r.field_71441_e.func_72933_a(new Vec3d(d0 + (double)f3, d1 + (double)f4, d2 + (double)f5), new Vec3d(d0 - d4 + (double)f3 + (double)f5, d1 - d6 + (double)f4, d2 - d5 + (double)f5));
 
                     if (raytraceresult != null)
                     {
@@ -683,19 +638,20 @@
 
         if (!this.field_78531_r.field_71474_y.field_74325_U)
         {
-            GlStateManager.func_179114_b(entity.field_70127_C + (entity.field_70125_A - entity.field_70127_C) * p_78467_1_, 1.0F, 0.0F, 0.0F);
-
+            float yaw = entity.field_70126_B + (entity.field_70177_z - entity.field_70126_B) * p_78467_1_ + 180.0F;
+            float pitch = entity.field_70127_C + (entity.field_70125_A - entity.field_70127_C) * p_78467_1_;
+            float roll = 0.0F;
             if (entity instanceof EntityAnimal)
             {
                 EntityAnimal entityanimal = (EntityAnimal)entity;
-                GlStateManager.func_179114_b(
-                    entityanimal.field_70758_at + (entityanimal.field_70759_as - entityanimal.field_70758_at) * p_78467_1_ + 180.0F, 0.0F, 1.0F, 0.0F
-                );
-            }
-            else
-            {
-                GlStateManager.func_179114_b(entity.field_70126_B + (entity.field_70177_z - entity.field_70126_B) * p_78467_1_ + 180.0F, 0.0F, 1.0F, 0.0F);
-            }
+                yaw = entityanimal.field_70758_at + (entityanimal.field_70759_as - entityanimal.field_70758_at) * p_78467_1_ + 180.0F;
+            }
+            IBlockState state = ActiveRenderInfo.func_186703_a(this.field_78531_r.field_71441_e, entity, p_78467_1_);
+            net.minecraftforge.client.event.EntityViewRenderEvent.CameraSetup event = new net.minecraftforge.client.event.EntityViewRenderEvent.CameraSetup(this, entity, state, p_78467_1_, yaw, pitch, roll);
+            net.minecraftforge.common.MinecraftForge.EVENT_BUS.post(event);
+            GlStateManager.func_179114_b(event.getRoll(), 0.0F, 0.0F, 1.0F);
+            GlStateManager.func_179114_b(event.getPitch(), 1.0F, 0.0F, 0.0F);
+            GlStateManager.func_179114_b(event.getYaw(), 0.0F, 1.0F, 0.0F);
         }
 
         GlStateManager.func_179109_b(0.0F, -f, 0.0F);
@@ -717,18 +673,13 @@
             GlStateManager.func_179109_b((float)(-(p_78479_2_ * 2 - 1)) * 0.07F, 0.0F, 0.0F);
         }
 
-        if (this.field_78503_V != 1.0)
+        if (this.field_78503_V != 1.0D)
         {
             GlStateManager.func_179109_b((float)this.field_78502_W, (float)(-this.field_78509_X), 0.0F);
-            GlStateManager.func_179139_a(this.field_78503_V, this.field_78503_V, 1.0);
+            GlStateManager.func_179139_a(this.field_78503_V, this.field_78503_V, 1.0D);
         }
 
-        Project.gluPerspective(
-            this.func_78481_a(p_78479_1_, true),
-            (float)this.field_78531_r.field_71443_c / (float)this.field_78531_r.field_71440_d,
-            0.05F,
-            this.field_78530_s * MathHelper.field_180189_a
-        );
+        Project.gluPerspective(this.func_78481_a(p_78479_1_, true), (float)this.field_78531_r.field_71443_c / (float)this.field_78531_r.field_71440_d, 0.05F, this.field_78530_s * MathHelper.field_180189_a);
         GlStateManager.func_179128_n(5888);
         GlStateManager.func_179096_D();
 
@@ -744,8 +695,7 @@
             this.func_78475_f(p_78479_1_);
         }
 
-        float f1 = this.field_78531_r.field_71439_g.field_71080_cy
-                   + (this.field_78531_r.field_71439_g.field_71086_bY - this.field_78531_r.field_71439_g.field_71080_cy) * p_78479_1_;
+        float f1 = this.field_78531_r.field_71439_g.field_71080_cy + (this.field_78531_r.field_71439_g.field_71086_bY - this.field_78531_r.field_71439_g.field_71080_cy) * p_78479_1_;
 
         if (f1 > 0.0F)
         {
@@ -757,7 +707,7 @@
             }
 
             float f2 = 5.0F / (f1 * f1 + 5.0F) - f1 * 0.04F;
-            f2 *= f2;
+            f2 = f2 * f2;
             GlStateManager.func_179114_b(((float)this.field_78529_t + p_78479_1_) * (float)i, 0.0F, 1.0F, 1.0F);
             GlStateManager.func_179152_a(1.0F / f2, 1.0F, 1.0F);
             GlStateManager.func_179114_b(-((float)this.field_78529_t + p_78479_1_) * (float)i, 0.0F, 1.0F, 1.0F);
@@ -800,12 +750,7 @@
                 GlStateManager.func_179109_b((float)(-(p_78476_2_ * 2 - 1)) * 0.07F, 0.0F, 0.0F);
             }
 
-            Project.gluPerspective(
-                this.func_78481_a(p_78476_1_, false),
-                (float)this.field_78531_r.field_71443_c / (float)this.field_78531_r.field_71440_d,
-                0.05F,
-                this.field_78530_s * 2.0F
-            );
+            Project.gluPerspective(this.func_78481_a(p_78476_1_, false), (float)this.field_78531_r.field_71443_c / (float)this.field_78531_r.field_71440_d, 0.05F, this.field_78530_s * 2.0F);
             GlStateManager.func_179128_n(5888);
             GlStateManager.func_179096_D();
 
@@ -822,13 +767,10 @@
                 this.func_78475_f(p_78476_1_);
             }
 
-            boolean flag = this.field_78531_r.func_175606_aa() instanceof EntityLivingBase
-                           && ((EntityLivingBase)this.field_78531_r.func_175606_aa()).func_70608_bn();
+            boolean flag = this.field_78531_r.func_175606_aa() instanceof EntityLivingBase && ((EntityLivingBase)this.field_78531_r.func_175606_aa()).func_70608_bn();
 
-            if (this.field_78531_r.field_71474_y.field_74320_O == 0
-                    && !flag
-                    && !this.field_78531_r.field_71474_y.field_74319_N
-                    && !this.field_78531_r.field_71442_b.func_78747_a())
+            if (!net.minecraftforge.client.ForgeHooksClient.renderFirstPersonHand(field_78531_r.field_71438_f, p_78476_1_, p_78476_2_))
+            if (this.field_78531_r.field_71474_y.field_74320_O == 0 && !flag && !this.field_78531_r.field_71474_y.field_74319_N && !this.field_78531_r.field_71442_b.func_78747_a())
             {
                 this.func_180436_i();
                 this.field_78516_c.func_78440_a(p_78476_1_);
@@ -879,7 +821,7 @@
     private void func_78470_f()
     {
         this.field_175075_L = (float)((double)this.field_175075_L + (Math.random() - Math.random()) * Math.random() * Math.random());
-        this.field_175075_L = (float)((double)this.field_175075_L * 0.9);
+        this.field_175075_L = (float)((double)this.field_175075_L * 0.9D);
         this.field_78514_e += this.field_175075_L - this.field_78514_e;
         this.field_78536_aa = true;
     }
@@ -932,6 +874,15 @@
                         f10 = 0.25F + f7 * 0.75F;
                     }
 
+                    float[] colors = {f8, f9, f10};
+                    world.field_73011_w.getLightmapColors(p_78472_1_, f, f2, f3, colors);
+                    f8 = colors[0]; f9 = colors[1]; f10 = colors[2];
+
+                    // Forge: fix MC-58177
+                    f8 = MathHelper.func_76131_a(f8, 0f, 1f);
+                    f9 = MathHelper.func_76131_a(f9, 0f, 1f);
+                    f10 = MathHelper.func_76131_a(f10, 0f, 1f);
+
                     if (this.field_78531_r.field_71439_g.func_70644_a(MobEffects.field_76439_r))
                     {
                         float f15 = this.func_180438_a(this.field_78531_r.field_71439_g, p_78472_1_);
@@ -1015,7 +966,7 @@
                     int k = (int)(f8 * 255.0F);
                     int l = (int)(f9 * 255.0F);
                     int i1 = (int)(f10 * 255.0F);
-                    this.field_78504_Q[i] = 0xFF000000 | k << 16 | l << 8 | i1;
+                    this.field_78504_Q[i] = -16777216 | k << 16 | l << 8 | i1;
                 }
 
                 this.field_78513_d.func_110564_a();
@@ -1028,7 +979,7 @@
     private float func_180438_a(EntityLivingBase p_180438_1_, float p_180438_2_)
     {
         int i = p_180438_1_.func_70660_b(MobEffects.field_76439_r).func_76459_b();
-        return i > 200 ? 1.0F : 0.7F + MathHelper.func_76126_a(((float)i - p_180438_2_) * (float) Math.PI * 0.2F) * 0.3F;
+        return i > 200 ? 1.0F : 0.7F + MathHelper.func_76126_a(((float)i - p_180438_2_) * (float)Math.PI * 0.2F) * 0.3F;
     }
 
     public void func_181560_a(float p_181560_1_, long p_181560_2_)
@@ -1158,6 +1109,10 @@
                 GlStateManager.func_179096_D();
                 this.func_78478_c();
                 this.field_78510_Z = System.nanoTime();
+                // Forge: Fix MC-112292
+                net.minecraft.client.renderer.tileentity.TileEntityRendererDispatcher.field_147556_a.field_147553_e = this.field_78531_r.func_110434_K();
+                // Forge: also fix rendering text before entering world (not part of MC-112292, but the same reason)
+                net.minecraft.client.renderer.tileentity.TileEntityRendererDispatcher.field_147556_a.field_147557_n = this.field_78531_r.field_71466_p;
             }
 
             if (this.field_78531_r.field_71462_r != null)
@@ -1166,7 +1121,7 @@
 
                 try
                 {
-                    this.field_78531_r.field_71462_r.func_73863_a(k1, l1, this.field_78531_r.func_193989_ak());
+                    net.minecraftforge.client.ForgeHooksClient.drawScreen(this.field_78531_r.field_71462_r, k1, l1, this.field_78531_r.func_193989_ak());
                 }
                 catch (Throwable throwable)
                 {
@@ -1186,23 +1141,13 @@
                             return String.format("Scaled: (%d, %d). Absolute: (%d, %d)", k1, l1, Mouse.getX(), Mouse.getY());
                         }
                     });
-                    crashreportcategory.func_189529_a(
-                        "Screen size",
-                        new ICrashReportDetail<String>()
+                    crashreportcategory.func_189529_a("Screen size", new ICrashReportDetail<String>()
                     {
                         public String call() throws Exception
                         {
-                            return String.format(
-                                       "Scaled: (%d, %d). Absolute: (%d, %d). Scale factor of %d",
-                                       scaledresolution.func_78326_a(),
-                                       scaledresolution.func_78328_b(),
-                                       EntityRenderer.this.field_78531_r.field_71443_c,
-                                       EntityRenderer.this.field_78531_r.field_71440_d,
-                                       scaledresolution.func_78325_e()
-                                   );
+                            return String.format("Scaled: (%d, %d). Absolute: (%d, %d). Scale factor of %d", scaledresolution.func_78326_a(), scaledresolution.func_78328_b(), EntityRenderer.this.field_78531_r.field_71443_c, EntityRenderer.this.field_78531_r.field_71440_d, scaledresolution.func_78325_e());
                         }
-                    }
-                    );
+                    });
                     throw new ReportedException(crashreport);
                 }
             }
@@ -1211,13 +1156,9 @@
 
     private void func_184373_n()
     {
-        if (this.field_78531_r.field_71438_f.func_184382_g() > 10
-                && this.field_78531_r.field_71438_f.func_184384_n()
-                && !this.field_78531_r.func_71401_C().func_184106_y())
+        if (this.field_78531_r.field_71438_f.func_184382_g() > 10 && this.field_78531_r.field_71438_f.func_184384_n() && !this.field_78531_r.func_71401_C().func_184106_y())
         {
-            BufferedImage bufferedimage = ScreenShotHelper.func_186719_a(
-                                              this.field_78531_r.field_71443_c, this.field_78531_r.field_71440_d, this.field_78531_r.func_147110_a()
-                                          );
+            BufferedImage bufferedimage = ScreenShotHelper.func_186719_a(this.field_78531_r.field_71443_c, this.field_78531_r.field_71440_d, this.field_78531_r.func_147110_a());
             int i = bufferedimage.getWidth();
             int j = bufferedimage.getHeight();
             int k = 0;
@@ -1237,7 +1178,7 @@
             {
                 BufferedImage bufferedimage1 = new BufferedImage(64, 64, 1);
                 Graphics graphics = bufferedimage1.createGraphics();
-                graphics.drawImage(bufferedimage, 0, 0, 64, 64, k, l, k + i, l + i, null);
+                graphics.drawImage(bufferedimage, 0, 0, 64, 64, k, l, k + i, l + i, (ImageObserver)null);
                 graphics.dispose();
                 ImageIO.write(bufferedimage1, "png", this.field_78531_r.func_71401_C().func_184109_z());
             }
@@ -1275,7 +1216,7 @@
 
                     if (this.field_78531_r.field_71442_b.func_178889_l() == GameType.SPECTATOR)
                     {
-                        flag = block.func_149716_u() && this.field_78531_r.field_71441_e.func_175625_s(blockpos) instanceof IInventory;
+                        flag = block.hasTileEntity(this.field_78531_r.field_71441_e.func_180495_p(blockpos)) && this.field_78531_r.field_71441_e.func_175625_s(blockpos) instanceof IInventory;
                     }
                     else
                     {
@@ -1333,7 +1274,7 @@
         GlStateManager.func_179086_m(16640);
         this.field_78531_r.field_71424_I.func_76318_c("camera");
         this.func_78479_a(p_175068_2_, p_175068_1_);
-        ActiveRenderInfo.func_74583_a(this.field_78531_r.field_71439_g, this.field_78531_r.field_71474_y.field_74320_O == 2);
+        ActiveRenderInfo.updateRenderInfo(this.field_78531_r.func_175606_aa(), this.field_78531_r.field_71474_y.field_74320_O == 2); //Forge: MC-46445 Spectator mode particles and sounds computed from where you have been before
         this.field_78531_r.field_71424_I.func_76318_c("frustum");
         ClippingHelperImpl.func_78558_a();
         this.field_78531_r.field_71424_I.func_76318_c("culling");
@@ -1350,29 +1291,19 @@
             this.field_78531_r.field_71424_I.func_76318_c("sky");
             GlStateManager.func_179128_n(5889);
             GlStateManager.func_179096_D();
-            Project.gluPerspective(
-                this.func_78481_a(p_175068_2_, true),
-                (float)this.field_78531_r.field_71443_c / (float)this.field_78531_r.field_71440_d,
-                0.05F,
-                this.field_78530_s * 2.0F
-            );
+            Project.gluPerspective(this.func_78481_a(p_175068_2_, true), (float)this.field_78531_r.field_71443_c / (float)this.field_78531_r.field_71440_d, 0.05F, this.field_78530_s * 2.0F);
             GlStateManager.func_179128_n(5888);
             renderglobal.func_174976_a(p_175068_2_, p_175068_1_);
             GlStateManager.func_179128_n(5889);
             GlStateManager.func_179096_D();
-            Project.gluPerspective(
-                this.func_78481_a(p_175068_2_, true),
-                (float)this.field_78531_r.field_71443_c / (float)this.field_78531_r.field_71440_d,
-                0.05F,
-                this.field_78530_s * MathHelper.field_180189_a
-            );
+            Project.gluPerspective(this.func_78481_a(p_175068_2_, true), (float)this.field_78531_r.field_71443_c / (float)this.field_78531_r.field_71440_d, 0.05F, this.field_78530_s * MathHelper.field_180189_a);
             GlStateManager.func_179128_n(5888);
         }
 
         this.func_78468_a(0, p_175068_2_);
         GlStateManager.func_179103_j(7425);
 
-        if (entity.field_70163_u + (double)entity.func_70047_e() < 128.0)
+        if (entity.field_70163_u + (double)entity.func_70047_e() < 128.0D)
         {
             this.func_180437_a(renderglobal, p_175068_2_, p_175068_1_, d0, d1, d2);
         }
@@ -1396,7 +1327,9 @@
         GlStateManager.func_179118_c();
         renderglobal.func_174977_a(BlockRenderLayer.SOLID, (double)p_175068_2_, p_175068_1_, entity);
         GlStateManager.func_179141_d();
+        this.field_78531_r.func_110434_K().func_110581_b(TextureMap.field_110575_b).func_174936_b(false, this.field_78531_r.field_71474_y.field_151442_I > 0); // FORGE: fix flickering leaves when mods mess up the blurMipmap settings
         renderglobal.func_174977_a(BlockRenderLayer.CUTOUT_MIPPED, (double)p_175068_2_, p_175068_1_, entity);
+        this.field_78531_r.func_110434_K().func_110581_b(TextureMap.field_110575_b).func_174935_a();
         this.field_78531_r.func_110434_K().func_110581_b(TextureMap.field_110575_b).func_174936_b(false, false);
         renderglobal.func_174977_a(BlockRenderLayer.CUTOUT, (double)p_175068_2_, p_175068_1_, entity);
         this.field_78531_r.func_110434_K().func_110581_b(TextureMap.field_110575_b).func_174935_a();
@@ -1410,7 +1343,9 @@
             GlStateManager.func_179094_E();
             RenderHelper.func_74519_b();
             this.field_78531_r.field_71424_I.func_76318_c("entities");
+            net.minecraftforge.client.ForgeHooksClient.setRenderPass(0);
             renderglobal.func_180446_a(entity, icamera, p_175068_2_);
+            net.minecraftforge.client.ForgeHooksClient.setRenderPass(0);
             RenderHelper.func_74518_a();
             this.func_175072_h();
         }
@@ -1423,6 +1358,7 @@
             EntityPlayer entityplayer = (EntityPlayer)entity;
             GlStateManager.func_179118_c();
             this.field_78531_r.field_71424_I.func_76318_c("outline");
+            if (!net.minecraftforge.client.ForgeHooksClient.onDrawBlockHighlight(renderglobal, entityplayer, field_78531_r.field_71476_x, 0, p_175068_2_))
             renderglobal.func_72731_b(entityplayer, this.field_78531_r.field_71476_x, 0, p_175068_2_);
             GlStateManager.func_179141_d();
         }
@@ -1434,9 +1370,7 @@
 
         this.field_78531_r.field_71424_I.func_76318_c("destroyProgress");
         GlStateManager.func_179147_l();
-        GlStateManager.func_187428_a(
-            GlStateManager.SourceFactor.SRC_ALPHA, GlStateManager.DestFactor.ONE, GlStateManager.SourceFactor.ONE, GlStateManager.DestFactor.ZERO
-        );
+        GlStateManager.func_187428_a(GlStateManager.SourceFactor.SRC_ALPHA, GlStateManager.DestFactor.ONE, GlStateManager.SourceFactor.ONE, GlStateManager.DestFactor.ZERO);
         this.field_78531_r.func_110434_K().func_110581_b(TextureMap.field_110575_b).func_174936_b(false, false);
         renderglobal.func_174981_a(Tessellator.func_178181_a(), Tessellator.func_178181_a().func_178180_c(), entity, p_175068_2_);
         this.field_78531_r.func_110434_K().func_110581_b(TextureMap.field_110575_b).func_174935_a();
@@ -1462,9 +1396,7 @@
         renderglobal.func_180449_a(entity, p_175068_2_);
         GlStateManager.func_179084_k();
         GlStateManager.func_179089_o();
-        GlStateManager.func_187428_a(
-            GlStateManager.SourceFactor.SRC_ALPHA, GlStateManager.DestFactor.ONE_MINUS_SRC_ALPHA, GlStateManager.SourceFactor.ONE, GlStateManager.DestFactor.ZERO
-        );
+        GlStateManager.func_187428_a(GlStateManager.SourceFactor.SRC_ALPHA, GlStateManager.DestFactor.ONE_MINUS_SRC_ALPHA, GlStateManager.SourceFactor.ONE, GlStateManager.DestFactor.ZERO);
         GlStateManager.func_179092_a(516, 0.1F);
         this.func_78468_a(0, p_175068_2_);
         GlStateManager.func_179147_l();
@@ -1473,18 +1405,32 @@
         GlStateManager.func_179103_j(7425);
         this.field_78531_r.field_71424_I.func_76318_c("translucent");
         renderglobal.func_174977_a(BlockRenderLayer.TRANSLUCENT, (double)p_175068_2_, p_175068_1_, entity);
+        if (!this.field_175078_W) //Only render if render pass 0 happens as well.
+        {
+            RenderHelper.func_74519_b();
+            this.field_78531_r.field_71424_I.func_76318_c("entities");
+            net.minecraftforge.client.ForgeHooksClient.setRenderPass(1);
+            renderglobal.func_180446_a(entity, icamera, p_175068_2_);
+            // restore blending function changed by RenderGlobal.preRenderDamagedBlocks
+            GlStateManager.func_187428_a(GlStateManager.SourceFactor.SRC_ALPHA, GlStateManager.DestFactor.ONE_MINUS_SRC_ALPHA, GlStateManager.SourceFactor.ONE, GlStateManager.DestFactor.ZERO);
+            net.minecraftforge.client.ForgeHooksClient.setRenderPass(-1);
+            RenderHelper.func_74518_a();
+        }
         GlStateManager.func_179103_j(7424);
         GlStateManager.func_179132_a(true);
         GlStateManager.func_179089_o();
         GlStateManager.func_179084_k();
         GlStateManager.func_179106_n();
 
-        if (entity.field_70163_u + (double)entity.func_70047_e() >= 128.0)
+        if (entity.field_70163_u + (double)entity.func_70047_e() >= 128.0D)
         {
             this.field_78531_r.field_71424_I.func_76318_c("aboveClouds");
             this.func_180437_a(renderglobal, p_175068_2_, p_175068_1_, d0, d1, d2);
         }
 
+        this.field_78531_r.field_71424_I.func_76318_c("forge_render_last");
+        net.minecraftforge.client.ForgeHooksClient.dispatchRenderLast(renderglobal, p_175068_2_);
+
         this.field_78531_r.field_71424_I.func_76318_c("hand");
 
         if (this.field_175074_C)
@@ -1501,12 +1447,7 @@
             this.field_78531_r.field_71424_I.func_76318_c("clouds");
             GlStateManager.func_179128_n(5889);
             GlStateManager.func_179096_D();
-            Project.gluPerspective(
-                this.func_78481_a(p_180437_2_, true),
-                (float)this.field_78531_r.field_71443_c / (float)this.field_78531_r.field_71440_d,
-                0.05F,
-                this.field_78530_s * 4.0F
-            );
+            Project.gluPerspective(this.func_78481_a(p_180437_2_, true), (float)this.field_78531_r.field_71443_c / (float)this.field_78531_r.field_71440_d, 0.05F, this.field_78530_s * 4.0F);
             GlStateManager.func_179128_n(5888);
             GlStateManager.func_179094_E();
             this.func_78468_a(0, p_180437_2_);
@@ -1515,12 +1456,7 @@
             GlStateManager.func_179121_F();
             GlStateManager.func_179128_n(5889);
             GlStateManager.func_179096_D();
-            Project.gluPerspective(
-                this.func_78481_a(p_180437_2_, true),
-                (float)this.field_78531_r.field_71443_c / (float)this.field_78531_r.field_71440_d,
-                0.05F,
-                this.field_78530_s * MathHelper.field_180189_a
-            );
+            Project.gluPerspective(this.func_78481_a(p_180437_2_, true), (float)this.field_78531_r.field_71443_c / (float)this.field_78531_r.field_71440_d, 0.05F, this.field_78530_s * MathHelper.field_180189_a);
             GlStateManager.func_179128_n(5888);
         }
     }
@@ -1541,9 +1477,9 @@
             World world = this.field_78531_r.field_71441_e;
             BlockPos blockpos = new BlockPos(entity);
             int i = 10;
-            double d0 = 0.0;
-            double d1 = 0.0;
-            double d2 = 0.0;
+            double d0 = 0.0D;
+            double d1 = 0.0D;
+            double d2 = 0.0D;
             int j = 0;
             int k = (int)(100.0F * f * f);
 
@@ -1558,60 +1494,36 @@
 
             for (int l = 0; l < k; ++l)
             {
-                BlockPos blockpos1 = world.func_175725_q(
-                                         blockpos.func_177982_a(
-                                             this.field_78537_ab.nextInt(10) - this.field_78537_ab.nextInt(10), 0, this.field_78537_ab.nextInt(10) - this.field_78537_ab.nextInt(10)
-                                         )
-                                     );
+                BlockPos blockpos1 = world.func_175725_q(blockpos.func_177982_a(this.field_78537_ab.nextInt(10) - this.field_78537_ab.nextInt(10), 0, this.field_78537_ab.nextInt(10) - this.field_78537_ab.nextInt(10)));
                 Biome biome = world.func_180494_b(blockpos1);
                 BlockPos blockpos2 = blockpos1.func_177977_b();
                 IBlockState iblockstate = world.func_180495_p(blockpos2);
 
-                if (blockpos1.func_177956_o() <= blockpos.func_177956_o() + 10
-                        && blockpos1.func_177956_o() >= blockpos.func_177956_o() - 10
-                        && biome.func_76738_d()
-                        && biome.func_180626_a(blockpos1) >= 0.15F)
+                if (blockpos1.func_177956_o() <= blockpos.func_177956_o() + 10 && blockpos1.func_177956_o() >= blockpos.func_177956_o() - 10 && biome.func_76738_d() && biome.func_180626_a(blockpos1) >= 0.15F)
                 {
                     double d3 = this.field_78537_ab.nextDouble();
                     double d4 = this.field_78537_ab.nextDouble();
                     AxisAlignedBB axisalignedbb = iblockstate.func_185900_c(world, blockpos2);
 
-                    if (iblockstate.func_185904_a() == Material.field_151587_i || iblockstate.func_177230_c() == Blocks.field_189877_df)
-                    {
-                        this.field_78531_r
-                        .field_71441_e
-                        .func_175688_a(
-                            EnumParticleTypes.SMOKE_NORMAL,
-                            (double)blockpos1.func_177958_n() + d3,
-                            (double)((float)blockpos1.func_177956_o() + 0.1F) - axisalignedbb.field_72338_b,
-                            (double)blockpos1.func_177952_p() + d4,
-                            0.0,
-                            0.0,
-                            0.0,
-                            new int[0]
-                        );
-                    }
-                    else if (iblockstate.func_185904_a() != Material.field_151579_a)
-                    {
-                        if (this.field_78537_ab.nextInt(++j) == 0)
+                    if (iblockstate.func_185904_a() != Material.field_151587_i && iblockstate.func_177230_c() != Blocks.field_189877_df)
+                    {
+                        if (iblockstate.func_185904_a() != Material.field_151579_a)
                         {
-                            d0 = (double)blockpos2.func_177958_n() + d3;
-                            d1 = (double)((float)blockpos2.func_177956_o() + 0.1F) + axisalignedbb.field_72337_e - 1.0;
-                            d2 = (double)blockpos2.func_177952_p() + d4;
+                            ++j;
+
+                            if (this.field_78537_ab.nextInt(j) == 0)
+                            {
+                                d0 = (double)blockpos2.func_177958_n() + d3;
+                                d1 = (double)((float)blockpos2.func_177956_o() + 0.1F) + axisalignedbb.field_72337_e - 1.0D;
+                                d2 = (double)blockpos2.func_177952_p() + d4;
+                            }
+
+                            this.field_78531_r.field_71441_e.func_175688_a(EnumParticleTypes.WATER_DROP, (double)blockpos2.func_177958_n() + d3, (double)((float)blockpos2.func_177956_o() + 0.1F) + axisalignedbb.field_72337_e, (double)blockpos2.func_177952_p() + d4, 0.0D, 0.0D, 0.0D, new int[0]);
                         }
-
-                        this.field_78531_r
-                        .field_71441_e
-                        .func_175688_a(
-                            EnumParticleTypes.WATER_DROP,
-                            (double)blockpos2.func_177958_n() + d3,
-                            (double)((float)blockpos2.func_177956_o() + 0.1F) + axisalignedbb.field_72337_e,
-                            (double)blockpos2.func_177952_p() + d4,
-                            0.0,
-                            0.0,
-                            0.0,
-                            new int[0]
-                        );
+                    }
+                    else
+                    {
+                        this.field_78531_r.field_71441_e.func_175688_a(EnumParticleTypes.SMOKE_NORMAL, (double)blockpos1.func_177958_n() + d3, (double)((float)blockpos1.func_177956_o() + 0.1F) - axisalignedbb.field_72338_b, (double)blockpos1.func_177952_p() + d4, 0.0D, 0.0D, 0.0D, new int[0]);
                     }
                 }
             }
@@ -1620,8 +1532,7 @@
             {
                 this.field_78534_ac = 0;
 
-                if (d1 > (double)(blockpos.func_177956_o() + 1)
-                        && world.func_175725_q(blockpos).func_177956_o() > MathHelper.func_76141_d((float)blockpos.func_177956_o()))
+                if (d1 > (double)(blockpos.func_177956_o() + 1) && world.func_175725_q(blockpos).func_177956_o() > MathHelper.func_76141_d((float)blockpos.func_177956_o()))
                 {
                     this.field_78531_r.field_71441_e.func_184134_a(d0, d1, d2, SoundEvents.field_187919_gs, SoundCategory.WEATHER, 0.1F, 0.5F, false);
                 }
@@ -1635,9 +1546,16 @@
 
     protected void func_78474_d(float p_78474_1_)
     {
+        net.minecraftforge.client.IRenderHandler renderer = this.field_78531_r.field_71441_e.field_73011_w.getWeatherRenderer();
+        if (renderer != null)
+        {
+            renderer.render(p_78474_1_, this.field_78531_r.field_71441_e, field_78531_r);
+            return;
+        }
+
         float f = this.field_78531_r.field_71441_e.func_72867_j(p_78474_1_);
 
-        if (!(f <= 0.0F))
+        if (f > 0.0F)
         {
             this.func_180436_i();
             Entity entity = this.field_78531_r.func_175606_aa();
@@ -1650,12 +1568,7 @@
             GlStateManager.func_179129_p();
             GlStateManager.func_187432_a(0.0F, 1.0F, 0.0F);
             GlStateManager.func_179147_l();
-            GlStateManager.func_187428_a(
-                GlStateManager.SourceFactor.SRC_ALPHA,
-                GlStateManager.DestFactor.ONE_MINUS_SRC_ALPHA,
-                GlStateManager.SourceFactor.ONE,
-                GlStateManager.DestFactor.ZERO
-            );
+            GlStateManager.func_187428_a(GlStateManager.SourceFactor.SRC_ALPHA, GlStateManager.DestFactor.ONE_MINUS_SRC_ALPHA, GlStateManager.SourceFactor.ONE, GlStateManager.DestFactor.ZERO);
             GlStateManager.func_179092_a(516, 0.1F);
             double d0 = entity.field_70142_S + (entity.field_70165_t - entity.field_70142_S) * (double)p_78474_1_;
             double d1 = entity.field_70137_T + (entity.field_70163_u - entity.field_70137_T) * (double)p_78474_1_;
@@ -1679,8 +1592,8 @@
                 for (int l1 = i - i1; l1 <= i + i1; ++l1)
                 {
                     int i2 = (k1 - k + 16) * 32 + l1 - i + 16;
-                    double d3 = (double)this.field_175076_N[i2] * 0.5;
-                    double d4 = (double)this.field_175077_O[i2] * 0.5;
+                    double d3 = (double)this.field_175076_N[i2] * 0.5D;
+                    double d4 = (double)this.field_175077_O[i2] * 0.5D;
                     blockpos$mutableblockpos.func_181079_c(l1, 0, k1);
                     Biome biome = world.func_180494_b(blockpos$mutableblockpos);
 
@@ -1727,9 +1640,7 @@
                                     bufferbuilder.func_181668_a(7, DefaultVertexFormats.field_181704_d);
                                 }
 
-                                double d5 = -((double)(this.field_78529_t + l1 * l1 * 3121 + l1 * 45238971 + k1 * k1 * 418711 + k1 * 13761 & 31) + (double)p_78474_1_)
-                                            / 32.0
-                                            * (3.0 + this.field_78537_ab.nextDouble());
+                                double d5 = -((double)(this.field_78529_t + l1 * l1 * 3121 + l1 * 45238971 + k1 * k1 * 418711 + k1 * 13761 & 31) + (double)p_78474_1_) / 32.0D * (3.0D + this.field_78537_ab.nextDouble());
                                 double d6 = (double)((float)l1 + 0.5F) - entity.field_70165_t;
                                 double d7 = (double)((float)k1 + 0.5F) - entity.field_70161_v;
                                 float f3 = MathHelper.func_76133_a(d6 * d6 + d7 * d7) / (float)i1;
@@ -1738,26 +1649,10 @@
                                 int j3 = world.func_175626_b(blockpos$mutableblockpos, 0);
                                 int k3 = j3 >> 16 & 65535;
                                 int l3 = j3 & 65535;
-                                bufferbuilder.func_181662_b((double)l1 - d3 + 0.5, (double)l2, (double)k1 - d4 + 0.5)
-                                .func_187315_a(0.0, (double)k2 * 0.25 + d5)
-                                .func_181666_a(1.0F, 1.0F, 1.0F, f4)
-                                .func_187314_a(k3, l3)
-                                .func_181675_d();
-                                bufferbuilder.func_181662_b((double)l1 + d3 + 0.5, (double)l2, (double)k1 + d4 + 0.5)
-                                .func_187315_a(1.0, (double)k2 * 0.25 + d5)
-                                .func_181666_a(1.0F, 1.0F, 1.0F, f4)
-                                .func_187314_a(k3, l3)
-                                .func_181675_d();
-                                bufferbuilder.func_181662_b((double)l1 + d3 + 0.5, (double)k2, (double)k1 + d4 + 0.5)
-                                .func_187315_a(1.0, (double)l2 * 0.25 + d5)
-                                .func_181666_a(1.0F, 1.0F, 1.0F, f4)
-                                .func_187314_a(k3, l3)
-                                .func_181675_d();
-                                bufferbuilder.func_181662_b((double)l1 - d3 + 0.5, (double)k2, (double)k1 - d4 + 0.5)
-                                .func_187315_a(0.0, (double)l2 * 0.25 + d5)
-                                .func_181666_a(1.0F, 1.0F, 1.0F, f4)
-                                .func_187314_a(k3, l3)
-                                .func_181675_d();
+                                bufferbuilder.func_181662_b((double)l1 - d3 + 0.5D, (double)l2, (double)k1 - d4 + 0.5D).func_187315_a(0.0D, (double)k2 * 0.25D + d5).func_181666_a(1.0F, 1.0F, 1.0F, f4).func_187314_a(k3, l3).func_181675_d();
+                                bufferbuilder.func_181662_b((double)l1 + d3 + 0.5D, (double)l2, (double)k1 + d4 + 0.5D).func_187315_a(1.0D, (double)k2 * 0.25D + d5).func_181666_a(1.0F, 1.0F, 1.0F, f4).func_187314_a(k3, l3).func_181675_d();
+                                bufferbuilder.func_181662_b((double)l1 + d3 + 0.5D, (double)k2, (double)k1 + d4 + 0.5D).func_187315_a(1.0D, (double)l2 * 0.25D + d5).func_181666_a(1.0F, 1.0F, 1.0F, f4).func_187314_a(k3, l3).func_181675_d();
+                                bufferbuilder.func_181662_b((double)l1 - d3 + 0.5D, (double)k2, (double)k1 - d4 + 0.5D).func_187315_a(0.0D, (double)l2 * 0.25D + d5).func_181666_a(1.0F, 1.0F, 1.0F, f4).func_187314_a(k3, l3).func_181675_d();
                             }
                             else
                             {
@@ -1774,8 +1669,8 @@
                                 }
 
                                 double d8 = (double)(-((float)(this.field_78529_t & 511) + p_78474_1_) / 512.0F);
-                                double d9 = this.field_78537_ab.nextDouble() + (double)f1 * 0.01 * (double)((float)this.field_78537_ab.nextGaussian());
-                                double d10 = this.field_78537_ab.nextDouble() + (double)(f1 * (float)this.field_78537_ab.nextGaussian()) * 0.001;
+                                double d9 = this.field_78537_ab.nextDouble() + (double)f1 * 0.01D * (double)((float)this.field_78537_ab.nextGaussian());
+                                double d10 = this.field_78537_ab.nextDouble() + (double)(f1 * (float)this.field_78537_ab.nextGaussian()) * 0.001D;
                                 double d11 = (double)((float)l1 + 0.5F) - entity.field_70165_t;
                                 double d12 = (double)((float)k1 + 0.5F) - entity.field_70161_v;
                                 float f6 = MathHelper.func_76133_a(d11 * d11 + d12 * d12) / (float)i1;
@@ -1784,26 +1679,10 @@
                                 int i4 = (world.func_175626_b(blockpos$mutableblockpos, 0) * 3 + 15728880) / 4;
                                 int j4 = i4 >> 16 & 65535;
                                 int k4 = i4 & 65535;
-                                bufferbuilder.func_181662_b((double)l1 - d3 + 0.5, (double)l2, (double)k1 - d4 + 0.5)
-                                .func_187315_a(0.0 + d9, (double)k2 * 0.25 + d8 + d10)
-                                .func_181666_a(1.0F, 1.0F, 1.0F, f5)
-                                .func_187314_a(j4, k4)
-                                .func_181675_d();
-                                bufferbuilder.func_181662_b((double)l1 + d3 + 0.5, (double)l2, (double)k1 + d4 + 0.5)
-                                .func_187315_a(1.0 + d9, (double)k2 * 0.25 + d8 + d10)
-                                .func_181666_a(1.0F, 1.0F, 1.0F, f5)
-                                .func_187314_a(j4, k4)
-                                .func_181675_d();
-                                bufferbuilder.func_181662_b((double)l1 + d3 + 0.5, (double)k2, (double)k1 + d4 + 0.5)
-                                .func_187315_a(1.0 + d9, (double)l2 * 0.25 + d8 + d10)
-                                .func_181666_a(1.0F, 1.0F, 1.0F, f5)
-                                .func_187314_a(j4, k4)
-                                .func_181675_d();
-                                bufferbuilder.func_181662_b((double)l1 - d3 + 0.5, (double)k2, (double)k1 - d4 + 0.5)
-                                .func_187315_a(0.0 + d9, (double)l2 * 0.25 + d8 + d10)
-                                .func_181666_a(1.0F, 1.0F, 1.0F, f5)
-                                .func_187314_a(j4, k4)
-                                .func_181675_d();
+                                bufferbuilder.func_181662_b((double)l1 - d3 + 0.5D, (double)l2, (double)k1 - d4 + 0.5D).func_187315_a(0.0D + d9, (double)k2 * 0.25D + d8 + d10).func_181666_a(1.0F, 1.0F, 1.0F, f5).func_187314_a(j4, k4).func_181675_d();
+                                bufferbuilder.func_181662_b((double)l1 + d3 + 0.5D, (double)l2, (double)k1 + d4 + 0.5D).func_187315_a(1.0D + d9, (double)k2 * 0.25D + d8 + d10).func_181666_a(1.0F, 1.0F, 1.0F, f5).func_187314_a(j4, k4).func_181675_d();
+                                bufferbuilder.func_181662_b((double)l1 + d3 + 0.5D, (double)k2, (double)k1 + d4 + 0.5D).func_187315_a(1.0D + d9, (double)l2 * 0.25D + d8 + d10).func_181666_a(1.0F, 1.0F, 1.0F, f5).func_187314_a(j4, k4).func_181675_d();
+                                bufferbuilder.func_181662_b((double)l1 - d3 + 0.5D, (double)k2, (double)k1 - d4 + 0.5D).func_187315_a(0.0D + d9, (double)l2 * 0.25D + d8 + d10).func_181666_a(1.0F, 1.0F, 1.0F, f5).func_187314_a(j4, k4).func_181675_d();
                             }
                         }
                     }
@@ -1815,7 +1694,7 @@
                 tessellator.func_78381_a();
             }
 
-            bufferbuilder.func_178969_c(0.0, 0.0, 0.0);
+            bufferbuilder.func_178969_c(0.0D, 0.0D, 0.0D);
             GlStateManager.func_179089_o();
             GlStateManager.func_179084_k();
             GlStateManager.func_179092_a(516, 0.1F);
@@ -1829,7 +1708,7 @@
         GlStateManager.func_179086_m(256);
         GlStateManager.func_179128_n(5889);
         GlStateManager.func_179096_D();
-        GlStateManager.func_179130_a(0.0, scaledresolution.func_78327_c(), scaledresolution.func_78324_d(), 0.0, 1000.0, 3000.0);
+        GlStateManager.func_179130_a(0.0D, scaledresolution.func_78327_c(), scaledresolution.func_78324_d(), 0.0D, 1000.0D, 3000.0D);
         GlStateManager.func_179128_n(5888);
         GlStateManager.func_179096_D();
         GlStateManager.func_179109_b(0.0F, 0.0F, -2000.0F);
@@ -1840,7 +1719,7 @@
         World world = this.field_78531_r.field_71441_e;
         Entity entity = this.field_78531_r.func_175606_aa();
         float f = 0.25F + 0.75F * (float)this.field_78531_r.field_71474_y.field_151451_c / 32.0F;
-        f = 1.0F - (float)Math.pow((double)f, 0.25);
+        f = 1.0F - (float)Math.pow((double)f, 0.25D);
         Vec3d vec3d = world.func_72833_a(this.field_78531_r.func_175606_aa(), p_78466_1_);
         float f1 = (float)vec3d.field_72450_a;
         float f2 = (float)vec3d.field_72448_b;
@@ -1852,8 +1731,8 @@
 
         if (this.field_78531_r.field_71474_y.field_151451_c >= 4)
         {
-            double d0 = MathHelper.func_76126_a(world.func_72929_e(p_78466_1_)) > 0.0F ? -1.0 : 1.0;
-            Vec3d vec3d2 = new Vec3d(d0, 0.0, 0.0);
+            double d0 = MathHelper.func_76126_a(world.func_72929_e(p_78466_1_)) > 0.0F ? -1.0D : 1.0D;
+            Vec3d vec3d2 = new Vec3d(d0, 0.0D, 0.0D);
             float f5 = (float)entity.func_70676_i(p_78466_1_).func_72430_b(vec3d2);
 
             if (f5 < 0.0F)
@@ -1867,7 +1746,7 @@
 
                 if (afloat != null)
                 {
-                    f5 *= afloat[3];
+                    f5 = f5 * afloat[3];
                     this.field_175080_Q = this.field_175080_Q * (1.0F - f5) + afloat[0] * f5;
                     this.field_175082_R = this.field_175082_R * (1.0F - f5) + afloat[1] * f5;
                     this.field_175081_S = this.field_175081_S * (1.0F - f5) + afloat[2] * f5;
@@ -1908,29 +1787,16 @@
             this.field_175082_R = (float)vec3d3.field_72448_b;
             this.field_175081_S = (float)vec3d3.field_72449_c;
         }
-        else if (iblockstate.func_185904_a() == Material.field_151586_h)
-        {
-            float f12 = 0.0F;
-
-            if (entity instanceof EntityLivingBase)
-            {
-                f12 = (float)EnchantmentHelper.func_185292_c((EntityLivingBase)entity) * 0.2F;
-
-                if (((EntityLivingBase)entity).func_70644_a(MobEffects.field_76427_o))
-                {
-                    f12 = f12 * 0.3F + 0.6F;
-                }
-            }
-
-            this.field_175080_Q = 0.02F + f12;
-            this.field_175082_R = 0.02F + f12;
-            this.field_175081_S = 0.2F + f12;
-        }
-        else if (iblockstate.func_185904_a() == Material.field_151587_i)
-        {
-            this.field_175080_Q = 0.6F;
-            this.field_175082_R = 0.1F;
-            this.field_175081_S = 0.0F;
+        else
+        {
+            //Forge Moved to Block.
+            Vec3d viewport = ActiveRenderInfo.func_178806_a(entity, p_78466_1_);
+            BlockPos viewportPos = new BlockPos(viewport);
+            IBlockState viewportState = this.field_78531_r.field_71441_e.func_180495_p(viewportPos);
+            Vec3d inMaterialColor = viewportState.func_177230_c().getFogColor(this.field_78531_r.field_71441_e, viewportPos, viewportState, entity, new Vec3d(field_175080_Q, field_175082_R, field_175081_S), p_78466_1_);
+            this.field_175080_Q = (float)inMaterialColor.field_72450_a;
+            this.field_175082_R = (float)inMaterialColor.field_72448_b;
+            this.field_175081_S = (float)inMaterialColor.field_72449_c;
         }
 
         float f13 = this.field_78535_ad + (this.field_78539_ae - this.field_78535_ad) * p_78466_1_;
@@ -1949,18 +1815,18 @@
             }
             else
             {
-                d1 = 0.0;
+                d1 = 0.0D;
             }
         }
 
-        if (d1 < 1.0)
+        if (d1 < 1.0D)
         {
-            if (d1 < 0.0)
+            if (d1 < 0.0D)
             {
-                d1 = 0.0;
+                d1 = 0.0D;
             }
 
-            d1 *= d1;
+            d1 = d1 * d1;
             this.field_175080_Q = (float)((double)this.field_175080_Q * d1);
             this.field_175082_R = (float)((double)this.field_175082_R * d1);
             this.field_175081_S = (float)((double)this.field_175081_S * d1);
@@ -1989,6 +1855,9 @@
                 f6 = 1.0F / this.field_175081_S;
             }
 
+            // Forge: fix MC-4647 and MC-10480
+            if (Float.isInfinite(f6)) f6 = Math.nextAfter(f6, 0.0);
+
             this.field_175080_Q = this.field_175080_Q * (1.0F - f15) + this.field_175080_Q * f6 * f15;
             this.field_175082_R = this.field_175082_R * (1.0F - f15) + this.field_175082_R * f6 * f15;
             this.field_175081_S = this.field_175081_S * (1.0F - f15) + this.field_175081_S * f6 * f15;
@@ -2004,6 +1873,13 @@
             this.field_175081_S = f7;
         }
 
+        net.minecraftforge.client.event.EntityViewRenderEvent.FogColors event = new net.minecraftforge.client.event.EntityViewRenderEvent.FogColors(this, entity, iblockstate, p_78466_1_, this.field_175080_Q, this.field_175082_R, this.field_175081_S);
+        net.minecraftforge.common.MinecraftForge.EVENT_BUS.post(event);
+
+        this.field_175080_Q = event.getRed();
+        this.field_175082_R = event.getGreen();
+        this.field_175081_S = event.getBlue();
+
         GlStateManager.func_179082_a(this.field_175080_Q, this.field_175082_R, this.field_175081_S, 0.0F);
     }
 
@@ -2014,7 +1890,9 @@
         GlStateManager.func_187432_a(0.0F, -1.0F, 0.0F);
         GlStateManager.func_179131_c(1.0F, 1.0F, 1.0F, 1.0F);
         IBlockState iblockstate = ActiveRenderInfo.func_186703_a(this.field_78531_r.field_71441_e, entity, p_78468_2_);
-
+        float hook = net.minecraftforge.client.ForgeHooksClient.getFogDensity(this, entity, iblockstate, p_78468_2_, 0.1F);
+        if (hook >= 0) GlStateManager.func_179095_a(hook);
+        else
         if (entity instanceof EntityLivingBase && ((EntityLivingBase)entity).func_70644_a(MobEffects.field_76440_q))
         {
             float f1 = 5.0F;
@@ -2094,12 +1972,12 @@
                 GlStateManager.func_187412_c(34138, 34139);
             }
 
-            if (this.field_78531_r.field_71441_e.field_73011_w.func_76568_b((int)entity.field_70165_t, (int)entity.field_70161_v)
-                    || this.field_78531_r.field_71456_v.func_184046_j().func_184056_f())
+            if (this.field_78531_r.field_71441_e.field_73011_w.func_76568_b((int)entity.field_70165_t, (int)entity.field_70161_v) || this.field_78531_r.field_71456_v.func_184046_j().func_184056_f())
             {
                 GlStateManager.func_179102_b(f * 0.05F);
                 GlStateManager.func_179153_c(Math.min(f, 192.0F) * 0.5F);
             }
+            net.minecraftforge.client.ForgeHooksClient.onFogRender(this, entity, iblockstate, p_78468_2_, p_78468_1_, f);
         }
 
         GlStateManager.func_179142_g();
@@ -2121,9 +1999,9 @@
 
     private FloatBuffer func_78469_a(float p_78469_1_, float p_78469_2_, float p_78469_3_, float p_78469_4_)
     {
-        ((Buffer)this.field_78521_m).clear();
+        this.field_78521_m.clear();
         this.field_78521_m.put(p_78469_1_).put(p_78469_2_).put(p_78469_3_).put(p_78469_4_);
-        ((Buffer)this.field_78521_m).flip();
+        this.field_78521_m.flip();
         return this.field_78521_m;
     }
 
@@ -2138,18 +2016,7 @@
         return this.field_147709_v;
     }
 
-    public static void func_189692_a(
-            FontRenderer p_189692_0_,
-            String p_189692_1_,
-            float p_189692_2_,
-            float p_189692_3_,
-            float p_189692_4_,
-            int p_189692_5_,
-            float p_189692_6_,
-            float p_189692_7_,
-            boolean p_189692_8_,
-            boolean p_189692_9_
-        )
+    public static void func_189692_a(FontRenderer p_189692_0_, String p_189692_1_, float p_189692_2_, float p_189692_3_, float p_189692_4_, int p_189692_5_, float p_189692_6_, float p_189692_7_, boolean p_189692_8_, boolean p_189692_9_)
     {
         GlStateManager.func_179094_E();
         GlStateManager.func_179109_b(p_189692_2_, p_189692_3_, p_189692_4_);
@@ -2166,18 +2033,16 @@
         }
 
         GlStateManager.func_179147_l();
-        GlStateManager.func_187428_a(
-            GlStateManager.SourceFactor.SRC_ALPHA, GlStateManager.DestFactor.ONE_MINUS_SRC_ALPHA, GlStateManager.SourceFactor.ONE, GlStateManager.DestFactor.ZERO
-        );
+        GlStateManager.func_187428_a(GlStateManager.SourceFactor.SRC_ALPHA, GlStateManager.DestFactor.ONE_MINUS_SRC_ALPHA, GlStateManager.SourceFactor.ONE, GlStateManager.DestFactor.ZERO);
         int i = p_189692_0_.func_78256_a(p_189692_1_) / 2;
         GlStateManager.func_179090_x();
         Tessellator tessellator = Tessellator.func_178181_a();
         BufferBuilder bufferbuilder = tessellator.func_178180_c();
         bufferbuilder.func_181668_a(7, DefaultVertexFormats.field_181706_f);
-        bufferbuilder.func_181662_b((double)(-i - 1), (double)(-1 + p_189692_5_), 0.0).func_181666_a(0.0F, 0.0F, 0.0F, 0.25F).func_181675_d();
-        bufferbuilder.func_181662_b((double)(-i - 1), (double)(8 + p_189692_5_), 0.0).func_181666_a(0.0F, 0.0F, 0.0F, 0.25F).func_181675_d();
-        bufferbuilder.func_181662_b((double)(i + 1), (double)(8 + p_189692_5_), 0.0).func_181666_a(0.0F, 0.0F, 0.0F, 0.25F).func_181675_d();
-        bufferbuilder.func_181662_b((double)(i + 1), (double)(-1 + p_189692_5_), 0.0).func_181666_a(0.0F, 0.0F, 0.0F, 0.25F).func_181675_d();
+        bufferbuilder.func_181662_b((double)(-i - 1), (double)(-1 + p_189692_5_), 0.0D).func_181666_a(0.0F, 0.0F, 0.0F, 0.25F).func_181675_d();
+        bufferbuilder.func_181662_b((double)(-i - 1), (double)(8 + p_189692_5_), 0.0D).func_181666_a(0.0F, 0.0F, 0.0F, 0.25F).func_181675_d();
+        bufferbuilder.func_181662_b((double)(i + 1), (double)(8 + p_189692_5_), 0.0D).func_181666_a(0.0F, 0.0F, 0.0F, 0.25F).func_181675_d();
+        bufferbuilder.func_181662_b((double)(i + 1), (double)(-1 + p_189692_5_), 0.0D).func_181666_a(0.0F, 0.0F, 0.0F, 0.25F).func_181675_d();
         tessellator.func_78381_a();
         GlStateManager.func_179098_w();
 
@@ -2212,7 +2077,7 @@
             float f1 = f * f;
             float f2 = f * f1;
             float f3 = 10.25F * f2 * f1 + -24.95F * f1 * f1 + 25.5F * f2 + -13.8F * f1 + 4.0F * f;
-            float f4 = f3 * (float) Math.PI;
+            float f4 = f3 * (float)Math.PI;
             float f5 = this.field_190568_ad * (float)(p_190563_1_ / 4);
             float f6 = this.field_190569_ae * (float)(p_190563_2_ / 4);
             GlStateManager.func_179141_d();
@@ -2221,11 +2086,7 @@
             GlStateManager.func_179126_j();
             GlStateManager.func_179129_p();
             RenderHelper.func_74519_b();
-            GlStateManager.func_179109_b(
-                (float)(p_190563_1_ / 2) + f5 * MathHelper.func_76135_e(MathHelper.func_76126_a(f4 * 2.0F)),
-                (float)(p_190563_2_ / 2) + f6 * MathHelper.func_76135_e(MathHelper.func_76126_a(f4 * 2.0F)),
-                -50.0F
-            );
+            GlStateManager.func_179109_b((float)(p_190563_1_ / 2) + f5 * MathHelper.func_76135_e(MathHelper.func_76126_a(f4 * 2.0F)), (float)(p_190563_2_ / 2) + f6 * MathHelper.func_76135_e(MathHelper.func_76126_a(f4 * 2.0F)), -50.0F);
             float f7 = 50.0F + 175.0F * MathHelper.func_76126_a(f4);
             GlStateManager.func_179152_a(f7, -f7, f7);
             GlStateManager.func_179114_b(900.0F * MathHelper.func_76135_e(MathHelper.func_76126_a(f4)), 0.0F, 1.0F, 0.0F);
